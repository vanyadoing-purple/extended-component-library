{"version":3,"file":"place_data_provider.js","sourceRoot":"","sources":["../../../src/place_building_blocks/place_data_provider/place_data_provider.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * @license\r\n * Copyright 2023 Google LLC\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport {ContextProvider, provide} from '@lit/context';\r\nimport {html, PropertyValues} from 'lit';\r\nimport {customElement, property, state} from 'lit/decorators.js';\r\nimport {choose} from 'lit/directives/choose.js';\r\n\r\nimport {BaseComponent} from '../../base/base_component.js';\r\nimport {RequestErrorEvent} from '../../base/events.js';\r\nimport {SlotValidationController} from '../../base/slot_validation_controller.js';\r\nimport {STRING_ARRAY_ATTRIBUTE_CONVERTER} from '../../utils/attribute_converters.js';\r\nimport type {Place, PlaceResult} from '../../utils/googlemaps_types.js';\r\nimport {isNotAvailableError, isPlaceResult, makePlaceFromPlaceResult} from '../../utils/place_utils.js';\r\nimport {PlaceAttribution} from '../place_attribution/place_attribution.js';\r\nimport {type PlaceConsumerRegistration, placeConsumerRegistrationContext, placeContext, PlaceDataConsumer} from '../place_data_consumer.js';\r\n\r\nimport {CachedPlaceLookup} from './cached_place_lookup.js';\r\n\r\n\r\nenum LoadingState {\r\n  EMPTY = 'EMPTY',\r\n  LOADING = 'LOADING',\r\n  LOADED = 'LOADED',\r\n  ERROR = 'ERROR',\r\n}\r\n\r\nconst CACHE_SIZE = 100;\r\n\r\n/**\r\n * Provides place data to child components as context.\r\n *\r\n * This component can fetch place data from the Places API, or forward a Place\r\n * or PlaceResult object provided elsewhere in code. By default, this component\r\n * will only request fields from the Places API which are required to render\r\n * child components. The component will locally cache place data to avoid\r\n * redundant API requests.\r\n *\r\n * @slot - Elements to receive Places data.\r\n * @slot initial-loading - If specified, display this content when the component\r\n * is initially loading Places data. Content in this slot will receive Places\r\n * data, but some or all fields may be undefined.\r\n * @slot error - If specified, display this content when there was any error\r\n * loading data from the Places API.\r\n *\r\n * @event {RequestErrorEvent} gmpx-requesterror - Indicates an error condition\r\n * in an underlying Google Maps JavaScript API call. (React: onRequestError)\r\n */\r\n@customElement('gmpx-place-data-provider')\r\nexport class PlaceDataProvider extends BaseComponent {\r\n  /**\r\n   * If `place` is provided with a `Place` or `PlaceResult` instance, but does\r\n   * not contain fields required by child components, this element will make a\r\n   * request to the Place API to retrieve the missing data. Set\r\n   * `auto-fetch-disabled` to prevent the component from performing these\r\n   * requests.\r\n   */\r\n  @property({type: Boolean, attribute: 'auto-fetch-disabled', reflect: true})\r\n  autoFetchDisabled = false;\r\n\r\n  /**\r\n   * Manually specify the fields to request from the Places API.\r\n   *\r\n   * If unspecified, the component will request only fields used by child\r\n   * components.\r\n   */\r\n  @property({converter: STRING_ARRAY_ATTRIBUTE_CONVERTER, reflect: true})\r\n  fields?: string[];\r\n\r\n  /**\r\n   * The place to be displayed by this component. Provide a [Place\r\n   * ID](https://developers.google.com/maps/documentation/places/web-service/place-id)\r\n   * as a string to have the component look up and display details from the\r\n   * Place API. The component will not make further API requests if child\r\n   * components are added at a later time. If required, explicitly request a\r\n   * data fetch by re-setting `place` to the same Place ID as before.\r\n   *\r\n   * Alternatively, assign a `Place` or `PlaceResult` object to the `place`\r\n   * property to render it directly (note that the attribute, on the other hand,\r\n   * only accepts a Place ID string).\r\n   */\r\n  @property({type: String, hasChanged: () => true})\r\n  place?: string|Place|PlaceResult;\r\n\r\n  /**\r\n   * @ignore\r\n   * Place consumer registration functions, passed to child `PlaceDataConsumer`s\r\n   * via context.\r\n   */\r\n  @provide({context: placeConsumerRegistrationContext})\r\n  @property({attribute: false})\r\n  contextRegistration: PlaceConsumerRegistration = {\r\n    registerPlaceConsumer: (c) => void this.registerPlaceConsumer(c),\r\n    unregisterPlaceConsumer: (c) => void this.unregisterPlaceConsumer(c),\r\n  };\r\n\r\n  @state() private loadingState = LoadingState.EMPTY;\r\n\r\n  protected readonly slotValidator = new SlotValidationController(\r\n      this, this.logger, ['', 'initial-loading', 'error']);\r\n\r\n  private readonly placeConsumers = new Set<PlaceDataConsumer>();\r\n  private readonly placeAttributions = new Set<PlaceAttribution>();\r\n\r\n  private readonly placeContextProvider =\r\n      new ContextProvider(this, {context: placeContext});\r\n\r\n  /**\r\n   * Place data passed to child `PlaceDataConsumer`s via context.\r\n   */\r\n  private get contextPlace(): Place|undefined {\r\n    return this.placeContextProvider.value;\r\n  }\r\n\r\n  private set contextPlace(place: Place|undefined) {\r\n    // Force an update to the consumer even if the place is the same object.\r\n    // This allows developers to refresh the consumers by setting\r\n    // provider.place = provider.place, for example if they added/fetched new\r\n    // fields to the place object themselves.\r\n    this.placeContextProvider.setValue(place, /* force= */ true);\r\n  }\r\n\r\n  private static readonly placeLookup = new CachedPlaceLookup(CACHE_SIZE);\r\n\r\n  protected override render() {\r\n    return choose(this.loadingState, [\r\n      [LoadingState.EMPTY, () => html``],\r\n      [LoadingState.LOADING, () => html`<slot name=\"initial-loading\"></slot>`],\r\n      [LoadingState.LOADED, () => html`<slot></slot>`],\r\n      [LoadingState.ERROR, () => html`<slot name=\"error\"></slot>`]\r\n    ]);\r\n  }\r\n\r\n  protected override async updated(changedProperties: PropertyValues<this>) {\r\n    if (changedProperties.has('place')) {\r\n      try {\r\n        await this.updatePlace();\r\n      } catch (error: unknown) {\r\n        this.handleError(error);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async updatePlace() {\r\n    this.loadingState = LoadingState.LOADING;\r\n    // Set this.contextPlace to an appropriate Place v2, according to the\r\n    // type of this.place\r\n    if (!this.place) {  // undefined or empty string\r\n      this.contextPlace = undefined;\r\n      this.loadingState = LoadingState.EMPTY;\r\n      return;\r\n    } else if (typeof this.place === 'string') {\r\n      this.contextPlace =\r\n          await PlaceDataProvider.placeLookup.getPlace(this.place);\r\n    } else if (isPlaceResult(this.place)) {\r\n      this.contextPlace = await makePlaceFromPlaceResult(this.place, this);\r\n      PlaceDataProvider.placeLookup.updatePlace(this.contextPlace);\r\n    } else {  // this.place is a Place\r\n      this.contextPlace = this.place;\r\n      PlaceDataProvider.placeLookup.updatePlace(this.contextPlace);\r\n    }\r\n\r\n    // Fetch place data (a) if this.place is a Place ID, or (b) if this.place\r\n    // is an object and auto-fetch is enabled\r\n    if ((typeof this.place === 'string') || !this.autoFetchDisabled) {\r\n      let fields: string[];\r\n      if (this.fields?.length) {\r\n        fields = this.fields;\r\n      } else {\r\n        // Defer execution to ensure that place consumers finish registration\r\n        await 0;\r\n        fields = this.getConsumerFields();\r\n      }\r\n      try {\r\n        await this.contextPlace.fetchFields({fields});\r\n      } catch (error: unknown) {\r\n        if (isNotAvailableError(error, 'fetchFields()')) {\r\n          // If the SDK doesn't support fetchFields(), replace the Place with a\r\n          // shimmed version, taking advantage of the fallback capabilities of\r\n          // `makePlaceFromPlaceResult()`.\r\n          this.contextPlace =\r\n              await makePlaceFromPlaceResult({place_id: this.contextPlace.id});\r\n          PlaceDataProvider.placeLookup.updatePlace(this.contextPlace);\r\n          await this.contextPlace.fetchFields({fields});\r\n        } else {\r\n          throw error;\r\n        }\r\n      }\r\n      // Manually update consumers of the context Place, since the object has\r\n      // been mutated\r\n      for (const consumer of this.placeConsumers) {\r\n        consumer.requestUpdate(\r\n            'contextPlace', consumer.contextPlace, {hasChanged: () => true});\r\n      }\r\n    }\r\n    this.appendAttributionIfAbsent();\r\n    this.loadingState = LoadingState.LOADED;\r\n  }\r\n\r\n  private registerPlaceConsumer(consumer: PlaceDataConsumer) {\r\n    this.placeConsumers.add(consumer);\r\n    if (consumer instanceof PlaceAttribution) {\r\n      this.placeAttributions.add(consumer);\r\n    }\r\n  }\r\n\r\n  private unregisterPlaceConsumer(consumer: PlaceDataConsumer) {\r\n    this.placeConsumers.delete(consumer);\r\n    if (consumer instanceof PlaceAttribution) {\r\n      this.placeAttributions.delete(consumer);\r\n    }\r\n  }\r\n\r\n  private getConsumerFields(): Array<keyof Place> {\r\n    const fieldSet = new Set<keyof Place>();\r\n    for (const consumer of this.placeConsumers) {\r\n      for (const field of consumer.getRequiredFields()) {\r\n        fieldSet.add(field);\r\n      }\r\n    }\r\n    return Array.from(fieldSet.values());\r\n  }\r\n\r\n  /**\r\n   * Appends a Place Attribution component as child if none exists in order to\r\n   * comply with the Google Maps Platform Terms of Service.\r\n   */\r\n  private appendAttributionIfAbsent() {\r\n    if (this.placeAttributions.size === 0) {\r\n      this.appendChild(new PlaceAttribution());\r\n    }\r\n  }\r\n\r\n  private handleError(error: unknown) {\r\n    this.loadingState = LoadingState.ERROR;\r\n    const requestErrorEvent = new RequestErrorEvent(error);\r\n    this.dispatchEvent(requestErrorEvent);\r\n  }\r\n}\r\n\r\ndeclare global {\r\n  interface HTMLElementTagNameMap {\r\n    'gmpx-place-data-provider': PlaceDataProvider;\r\n  }\r\n}\r\n"]}